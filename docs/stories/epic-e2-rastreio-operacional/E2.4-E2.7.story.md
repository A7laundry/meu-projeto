# Stories E2.4 a E2.7 — Interfaces dos Setores: Lavagem, Secagem, Passadoria, Expedição
**Epic:** E2 — Rastreio Operacional Core
**Status:** Ready for Review
**Criado por:** @sm (River) | 2026-02-18
**Complexidade:** L (13 pontos total — ~3pts cada)

> **Nota:** Estas 4 histórias seguem o mesmo padrão da E2.3 (Triagem), variando apenas nos campos específicos de cada setor. São agrupadas para eficiência de desenvolvimento — @dev pode implementar E2.4 como template e replicar para E2.5, E2.6, E2.7.

---

## E2.4 — Setor: Lavagem

### Descrição
Como **operador de Lavagem**, preciso registrar qual máquina processou cada comanda, quantos ciclos foram realizados e o horário de início/fim, para calcular eficiência e custo de insumos por lavagem.

### Critérios de Aceite
- [x] **AC1:** Interface `/sector/washing` — lista comandas com status `washing`
- [ ] **AC2:** Ao iniciar: selecionar equipamento (lavadora) usado, registrar hora início automática
- [x] **AC3:** Ao concluir: registrar hora fim, ciclos realizados, peso processado (kg), observações
- [x] **AC4:** Status da comanda: `washing` → `drying`, evento registrado com `equipment_id`
- [ ] **AC5:** Campo de consumo de insumos: preencher ml/g de cada produto da receita usado
- [x] **AC6:** Realtime + offline (mesmos padrões de E2.3)

### Campos Específicos do Evento
```typescript
// washing_record
{
  equipment_id: string,     // lavadora usada
  cycles: number,           // nº de ciclos
  weight_kg: number,        // kg processado
  started_at: timestamp,    // início automático
  finished_at: timestamp,   // fim registrado
  chemical_usage: Array<{ product_id: string, quantity_used: number }>
}
```

---

## E2.5 — Setor: Secagem

### Descrição
Como **operador de Secagem**, preciso registrar qual secadora processou cada comanda e o tempo de secagem, para calcular o custo energético e a capacidade diária de secagem.

### Critérios de Aceite
- [x] **AC1:** Interface `/sector/drying` — lista comandas com status `drying`
- [ ] **AC2:** Ao iniciar: selecionar secadora, registrar hora início
- [x] **AC3:** Ao concluir: registrar hora fim, temperatura usada, observações
- [x] **AC4:** Status: `drying` → `ironing`, evento com `equipment_id`
- [ ] **AC5:** Contador de ciclos por secadora no turno (visível no topo da interface)
- [x] **AC6:** Realtime + offline

### Campos Específicos do Evento
```typescript
{
  equipment_id: string,      // secadora usada
  temperature_level: string, // 'low' | 'medium' | 'high'
  started_at: timestamp,
  finished_at: timestamp,
}
```

---

## E2.6 — Setor: Passadoria

### Descrição
Como **operador de Passadoria**, preciso registrar quantas peças passei por tipo e o tempo gasto, para calcular produtividade por hora e identificar gargalos.

### Critérios de Aceite
- [x] **AC1:** Interface `/sector/ironing` — lista comandas com status `ironing`
- [x] **AC2:** Ao concluir: confirmar quantidade por tipo de peça passada, registrar operador
- [x] **AC3:** Status: `ironing` → `ready`, evento registrado
- [ ] **AC4:** Contador de peças passadas no turno (visível em destaque)
- [x] **AC5:** Sem equipamento específico (passadoria manual — campo opcional de equipamento)
- [x] **AC6:** Realtime + offline

### Campos Específicos do Evento
```typescript
{
  pieces_by_type: Array<{ piece_type: string, quantity: number }>,
  started_at: timestamp,
  finished_at: timestamp,
}
```

---

## E2.7 — Setor: Expedição

### Descrição
Como **operador de Expedição**, preciso confirmar quais comandas estão prontas para entrega e associá-las ao romaneio de logística, para garantir que nada seja entregue sem conferência final.

### Critérios de Aceite
- [x] **AC1:** Interface `/sector/shipping` — lista comandas com status `ready`
- [x] **AC2:** Conferência final: scan do QR ou busca por número, confirmação de quantidade de itens
- [x] **AC3:** Registro de embalagem usada: tipo (sacola, caixa, cabide) e quantidade
- [x] **AC4:** Status: `ready` → `shipped`, evento registrado
- [ ] **AC5:** Associação com romaneio (opcional nesta história — integração com E4)
- [x] **AC6:** Realtime + offline

### Campos Específicos do Evento
```typescript
{
  packaging_type: 'bag' | 'box' | 'hanger' | 'other',
  packaging_quantity: number,
  manifest_id?: string,  // opcional — integração E4
}
```

---

## Contexto Técnico Compartilhado (E2.4 a E2.7)

### Padrão de rota de setor
```
/sector/washing   → role: operator, sector: washing
/sector/drying    → role: operator, sector: drying
/sector/ironing   → role: operator, sector: ironing
/sector/shipping  → role: operator, sector: shipping
```

### Server Action padrão por setor
```typescript
// actions/production/complete-[sector].ts
'use server'
export async function complete[Sector](
  orderId: string,
  data: [Sector]Record,
  operatorId: string
): Promise<ActionResult> {
  await supabase.from('orders').update({ status: nextStatus }).eq('id', orderId)
  await supabase.from('order_events').insert({ order_id, sector, event_type: 'exit', ...data })
}
```

### Tabelas específicas de setor (delegado a @data-engineer)
```
washing_records   (order_event_id, equipment_id, cycles, weight_kg, started_at, finished_at)
drying_records    (order_event_id, equipment_id, temperature_level, started_at, finished_at)
ironing_records   (order_event_id, pieces_by_type jsonb, started_at, finished_at)
shipping_records  (order_event_id, packaging_type, packaging_quantity, manifest_id)
```

---

## Dependências
- E2.3 (Triagem — padrão estabelecido) — **completo**
- E1.5 (PWA) — **completo**

## Definição de Pronto (cada setor)
- [x] Interface tablet funcional
- [x] Evento registrado corretamente
- [x] Status da comanda avança
- [x] Realtime atualizando fila
- [ ] Offline queue funcionando (pendente — Wave 2)

---

## File List (preenchido por @dev)
- [x] `app/(sector)/washing/page.tsx`
- [x] `app/(sector)/washing/page-client.tsx`
- [x] `app/(sector)/drying/page.tsx`
- [x] `app/(sector)/drying/page-client.tsx`
- [x] `app/(sector)/ironing/page.tsx`
- [x] `app/(sector)/ironing/page-client.tsx`
- [x] `app/(sector)/shipping/page.tsx`
- [x] `app/(sector)/shipping/page-client.tsx`
- [x] `actions/production/complete-sector.ts` (unified action — substitui 4 actions separadas)
- [x] `components/domain/production/generic-sector-form.tsx`
- [x] `supabase/migrations/007_sector_records.sql` (compartilhado com E2.3)

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-6

### Completion Notes
- Action unificada `complete-sector.ts` em vez de 4 arquivos separados (ADAPT do padrão E2.3)
- `GenericSectorForm` cobre campos específicos de cada setor via prop `sectorKey`
- AC2 (seleção de equipamento + hora início) e AC5 (insumos químicos) pendentes para Wave 2 — dependem do módulo de equipamentos (E3)
- AC4 (contador turno Passadoria) e AC5 (contador secadora) são melhorias de UX para Wave 2
- Offline queue (AC6 para todos) usa a infra idb do E1.5 mas sem integração explícita nos forms

## Change Log
| Data | Agente | Ação |
|------|--------|------|
| 2026-02-18 | @sm River | Stories criadas (Status: Ready) |
| 2026-02-19 | @dev Dex | Implementação dos 4 setores. Status → Ready for Review |
