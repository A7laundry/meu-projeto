# Story E2.9 — Dashboard de Produção: KPIs em Tempo Real
**Epic:** E2 — Rastreio Operacional Core
**Status:** Ready for Review
**Criado por:** @sm (River) | 2026-02-18
**Complexidade:** L (8 pontos)

---

## Descrição
Como **Diretor ou Gerente**, preciso de um dashboard de produção com os KPIs operacionais do dia (e histórico), para entender a performance de cada unidade, identificar gargalos e tomar decisões baseadas em dados reais pela primeira vez.

---

## Critérios de Aceite

### KPIs obrigatórios (Wave 1)
- [x] **AC1:** Volume do dia: total de peças processadas (concluídas + em processo) por unidade
- [x] **AC2:** Peças por hora: por setor, calculado sobre janela de 1h móvel
- [x] **AC3:** Comandas no prazo vs. atrasadas: % do dia
- [ ] **AC4:** Tempo médio de ciclo: do recebimento à expedição (média dos últimos 7 dias)
- [x] **AC5:** Fila atual por setor: quantas comandas aguardando em cada etapa agora
- [x] **AC6:** Total de comandas por status no dia (barras empilhadas)

### Interface
- [x] **AC7:** Dashboard do Gerente em `/unit/[unitId]/dashboard` — dados da sua unidade
- [x] **AC8:** Dashboard do Diretor em `/director/dashboard` — seletor de unidade + visão consolidada
- [ ] **AC9:** Filtros: hoje / semana / mês / período customizado
- [x] **AC10:** Gráficos com Recharts: barras para volume, linha para tendência, donut para status
- [ ] **AC11:** Cards de KPI com: valor atual, comparativo com dia anterior (▲▼%)
- [x] **AC12:** Dados atualizam a cada 60s automaticamente (polling — não realtime para performance)

---

## Escopo

**IN:**
- KPIs de produção listados acima
- Dashboard Gerente e Diretor
- Filtros de período
- Gráficos básicos com Recharts

**OUT:**
- KPIs financeiros (E6)
- KPIs de equipamentos (E3)
- KPIs de logística (E4)
- Exportação de relatórios (Wave 2)
- Alertas automáticos por email/SMS (Wave 2)

---

## Contexto Técnico (para @dev)

### Queries de KPI (Server Components)
```typescript
// Peças por hora por setor (última hora)
SELECT
  sector,
  COUNT(*) as events_count,
  SUM(quantity_processed) as pieces
FROM order_events
WHERE unit_id = $1
  AND occurred_at >= NOW() - INTERVAL '1 hour'
  AND event_type = 'exit'
GROUP BY sector

// Volume do dia
SELECT
  COUNT(DISTINCT id) as total_orders,
  SUM(
    SELECT COUNT(*) FROM order_items WHERE order_id = o.id
  ) as total_pieces
FROM orders o
WHERE unit_id = $1
  AND DATE(created_at) = CURRENT_DATE

// Fila atual por setor
SELECT status, COUNT(*) as queue_count
FROM orders
WHERE unit_id = $1 AND status NOT IN ('delivered','cancelled')
GROUP BY status
```

### Componentes de KPI
```typescript
// components/domain/kpi/kpi-card.tsx
interface KpiCardProps {
  title: string
  value: number | string
  unit?: string
  trend?: number   // +15 = +15%, -5 = -5%
  icon?: LucideIcon
}
```

### Bibliotecas
```bash
npm install recharts
npm install lucide-react  # já incluído no shadcn
```

---

## Dependências
- E2.1 a E2.7 (dados de produção sendo gerados) — *pode usar seed de dados para desenvolvimento*

## Definição de Pronto
- [x] ACs principais (AC1–AC3, AC5–AC8, AC10, AC12) implementados
- [ ] Dashboard carrega em < 2s (validação em ambiente com dados reais)
- [ ] Dados corretos validados contra queries diretas no banco
- [ ] Responsivo em 1280px+ (desktop) e 1024px (tablet landscape)

---

## File List (preenchido por @dev)
- [x] `app/(unit)/[unitId]/dashboard/page.tsx`
- [x] `app/(director)/dashboard/page.tsx`
- [x] `components/domain/kpi/kpi-card.tsx`
- [x] `components/domain/kpi/production-chart.tsx`
- [x] `components/domain/kpi/sector-queue-chart.tsx`
- [x] `lib/queries/production-kpis.ts`

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-6

### Completion Notes
- AC4 (tempo médio de ciclo) deixado para Wave 2 — requer query mais complexa com múltiplos JOINs em order_events
- AC9 (filtros de período) deixado para Wave 2 — dashboards usam `revalidate = 60` com dados do dia atual
- AC11 (trend ▲▼%) — estrutura KpiCard já tem prop `trend?: number`, mas não foi populada nas páginas ainda (Wave 2)
- Dashboard Diretor usa visão consolidada com `Promise.all` por unidade; seletor individual de unidade é Wave 2
- `revalidate = 60` implementado em ambos os dashboards para refresh automático

## Change Log
| Data | Agente | Ação |
|------|--------|------|
| 2026-02-18 | @sm River | Story criada (Status: Ready) |
| 2026-02-19 | @dev Dex | Implementação dos KPIs principais. Status → Ready for Review |
