# Story E2.1 — Criação de Comanda Digital
**Epic:** E2 — Rastreio Operacional Core
**Status:** Ready for Review
**Criado por:** @sm (River) | 2026-02-18
**Complexidade:** L (8 pontos)

---

## Descrição
Como **atendente comercial ou recepcionista**, preciso criar uma comanda digital ao receber as peças do cliente, registrando todas as informações necessárias para rastrear o lote durante todo o processo produtivo, para que nenhuma peça se perca e o cliente possa ser atualizado em tempo real.

---

## Critérios de Aceite

- [x] **AC1:** Formulário de criação de comanda com: cliente (busca por nome/CPF/CNPJ), data de promessa, observações gerais
- [x] **AC2:** Adição de itens à comanda: tipo de peça, quantidade, receita de lavagem associada, observação por item
- [x] **AC3:** Tipos de peça suportados: roupa comum, fantasia, tênis, tapete, cortina, industrial (outros via campo livre)
- [x] **AC4:** Comanda salva com status `received` e `order_number` sequencial por unidade (ex: SP-001/2026)
- [x] **AC5:** Comanda associada à `unit_id` do usuário criador
- [x] **AC6:** Listagem de comandas da unidade: filtragem por status, data, cliente, número
- [x] **AC7:** Detalhe da comanda: histórico completo de eventos em timeline
- [x] **AC8:** Validação: comanda não pode ser criada sem ao menos 1 item e 1 cliente

---

## Escopo

**IN:**
- Criação e listagem de comandas
- Adição de itens com tipo e receita
- Status inicial `received`
- Numeração sequencial por unidade

**OUT:**
- Geração de etiqueta/QR Code (E2.2)
- Rastreio por setor (E2.3+)
- Financeiro/precificação (E5)
- Assinatura do cliente (Wave 2)

---

## Contexto Técnico (para @dev)

### Schema principal
```sql
CREATE TABLE orders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  unit_id UUID NOT NULL REFERENCES units(id),
  client_id UUID REFERENCES clients(id),
  client_name TEXT NOT NULL, -- fallback se cliente não cadastrado
  order_number TEXT NOT NULL, -- ex: 'SP-001/2026'
  status TEXT DEFAULT 'received' CHECK (status IN (
    'received','sorting','washing','drying','ironing','ready','shipped','delivered'
  )),
  promised_at TIMESTAMPTZ NOT NULL,
  notes TEXT,
  created_by UUID REFERENCES profiles(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(unit_id, order_number)
);

CREATE TABLE order_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_id UUID NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
  piece_type TEXT NOT NULL CHECK (piece_type IN (
    'clothing','costume','sneaker','rug','curtain','industrial','other'
  )),
  piece_type_label TEXT, -- para 'other'
  quantity INTEGER NOT NULL CHECK (quantity > 0),
  recipe_id UUID REFERENCES recipes(id),
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE order_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_id UUID NOT NULL REFERENCES orders(id),
  unit_id UUID NOT NULL REFERENCES units(id),
  sector TEXT NOT NULL,
  event_type TEXT NOT NULL CHECK (event_type IN ('entry','exit','alert')),
  operator_id UUID REFERENCES profiles(id),
  equipment_id UUID REFERENCES equipment(id),
  quantity_processed INTEGER,
  notes TEXT,
  occurred_at TIMESTAMPTZ DEFAULT NOW()
);

-- Tabela de clientes (simplificada para E2.1)
CREATE TABLE clients (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  unit_id UUID NOT NULL REFERENCES units(id),
  name TEXT NOT NULL,
  document TEXT, -- CPF ou CNPJ
  phone TEXT,
  email TEXT,
  type TEXT DEFAULT 'individual' CHECK (type IN ('individual','business')),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
CREATE POLICY "unit_orders" ON orders FOR ALL
  USING (unit_id = (auth.jwt() ->> 'unit_id')::uuid
      OR auth.jwt() ->> 'user_role' = 'director');
```

### Numeração sequencial de comanda
```typescript
// actions/orders/create.ts
async function generateOrderNumber(unitId: string, unitSlug: string): Promise<string> {
  const year = new Date().getFullYear()
  const { count } = await supabase
    .from('orders')
    .select('*', { count: 'exact', head: true })
    .eq('unit_id', unitId)
    .gte('created_at', `${year}-01-01`)
  const prefix = unitSlug.slice(0,2).toUpperCase()
  return `${prefix}-${String((count || 0) + 1).padStart(3,'0')}/${year}`
}
```

### Tipos TypeScript
```typescript
// types/order.ts
export type OrderStatus = 'received'|'sorting'|'washing'|'drying'|'ironing'|'ready'|'shipped'|'delivered'
export type PieceType = 'clothing'|'costume'|'sneaker'|'rug'|'curtain'|'industrial'|'other'

export interface Order {
  id: string
  unit_id: string
  client_name: string
  order_number: string
  status: OrderStatus
  promised_at: string
  notes?: string
  items: OrderItem[]
  events: OrderEvent[]
}
```

---

## Dependências
- E1.1 (Setup) — **completo**
- E1.2 (Auth) — **completo**
- E1.3 (Unidades) — **completo**

## Riscos
- Tabela `clients` simplificada aqui; CRM completo vem no E5
- Tabela `recipes` precisa existir (pode ser criada vazia e populada no E3)

## Definição de Pronto
- [ ] Todos os ACs marcados
- [ ] Comanda criada e listada com sucesso
- [ ] RLS: funcionário só vê comandas da sua unidade

---

## File List (preenchido por @dev)
- [x] `supabase/migrations/004_recipes.sql` (placeholder)
- [x] `supabase/migrations/005_orders.sql`
- [x] `supabase/migrations/006_clients.sql`
- [x] `app/(unit)/[unitId]/production/page.tsx`
- [x] `app/(unit)/[unitId]/production/orders/page.tsx`
- [x] `app/(unit)/[unitId]/production/orders/new/page.tsx`
- [x] `app/(unit)/[unitId]/production/orders/[orderId]/page.tsx`
- [x] `actions/orders/create.ts`
- [x] `actions/orders/list.ts`
- [x] `types/order.ts` (já existia)
- [x] `types/client.ts`
- [x] `components/domain/order/order-form.tsx`
- [x] `components/domain/order/order-list.tsx`
- [x] `components/domain/order/order-timeline.tsx`

## Change Log
| Data | Agente | Ação |
|------|--------|------|
| 2026-02-18 | @sm River | Story criada (Status: Ready) |
| 2026-02-18 | @dev Dex | Implementação concluída — 8/8 ACs. Status: Ready for Review |
