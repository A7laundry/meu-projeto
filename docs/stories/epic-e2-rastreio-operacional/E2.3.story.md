# Story E2.3 — Interface de Setor: Triagem
**Epic:** E2 — Rastreio Operacional Core
**Status:** Ready for Review
**Criado por:** @sm (River) | 2026-02-18
**Complexidade:** M (5 pontos)

---

## Descrição
Como **funcionário da Triagem**, usando o tablet fixo no setor, preciso receber comandas, classificar as peças por tipo e atribuir a receita de lavagem correta, para que o setor de Lavagem saiba exatamente como processar cada lote.

---

## Critérios de Aceite

- [x] **AC1:** Interface fullscreen no tablet em `/sector/sorting` (sem navegação lateral)
- [x] **AC2:** Listagem de comandas aguardando triagem (status `received`) da unidade
- [x] **AC3:** Scan de QR Code via câmera do tablet para selecionar comanda (ou busca por número)
- [x] **AC4:** Para cada item da comanda: confirmar tipo de peça, selecionar receita de lavagem, informar peso (kg) opcional
- [x] **AC5:** Ao concluir: status da comanda muda para `sorting` → `washing`, evento registrado em `order_events`
- [x] **AC6:** Evento registra: `operator_id`, `sector: 'sorting'`, `event_type: 'exit'`, `occurred_at`, observações
- [x] **AC7:** Confirmação visual clara (toast + cor verde) ao concluir triagem de uma comanda
- [x] **AC8:** Fila atualiza em tempo real via Supabase Realtime (nova comanda aparece sem refresh)
- [ ] **AC9:** Interface funciona offline: ação salva em fila local e sincroniza ao reconectar

---

## Escopo

**IN:**
- Interface tablet do setor Triagem
- Registro de evento de saída da triagem
- Realtime na fila
- Offline queue

**OUT:**
- Edição da comanda (apenas visualização)
- Pesagem integrada com balança (Wave 2)
- Separação física de lotes (Wave 2)

---

## Contexto Técnico (para @dev)

### Rota e Layout
```
app/(sector)/sorting/page.tsx
→ usa SectorLayout (fullscreen, sem sidebar)
→ autenticação: role = 'operator', sector = 'sorting'
```

### Scan QR via câmera
```bash
npm install @zxing/browser  # biblioteca de scan QR/barcode
```
```typescript
// hooks/use-qr-scanner.ts
// Usa câmera traseira do tablet
// Retorna order_id ao detectar QR válido
```

### Server Action — registrar saída da triagem
```typescript
// actions/production/complete-sorting.ts
'use server'
export async function completeSorting(
  orderId: string,
  items: Array<{ itemId: string; recipeId: string; weightKg?: number }>,
  operatorId: string
): Promise<ActionResult> {
  // 1. Atualizar status da comanda para 'washing'
  // 2. Atualizar recipe_id dos itens
  // 3. Inserir order_event (sorting/exit)
  // 4. Broadcast via realtime automático (Supabase)
}
```

### Realtime subscription
```typescript
// hooks/use-sector-queue.ts
// Subscribe em orders WHERE unit_id = X AND status = 'received'
// Retorna lista reativa que atualiza automaticamente
```

---

## Dependências
- E2.1 (Comandas) — **completo**
- E1.5 (PWA + Offline) — **completo**
- E3.1 (Receitas de lavagem) — *pode usar receitas mockadas para desenvolvimento*

## Riscos
- Permissão de câmera no tablet precisa ser concedida pelo SO (não bloqueável pelo app)

## Definição de Pronto
- [x] ACs AC1–AC8 implementados
- [ ] Scan de QR funcionando em tablet Android (validação em device real)
- [ ] Realtime testado (2 dispositivos abertos simultaneamente)
- [ ] Offline: ação salva e sincronizada ao voltar online (AC9 pendente)

---

## File List (preenchido por @dev)
- [x] `app/(sector)/sorting/page.tsx`
- [x] `app/(sector)/sorting/page-client.tsx`
- [x] `components/domain/production/sector-queue.tsx`
- [x] `components/domain/production/sorting-form.tsx`
- [x] `hooks/use-qr-scanner.ts`
- [x] `hooks/use-sector-queue.ts`
- [x] `actions/production/complete-sorting.ts`
- [x] `supabase/migrations/007_sector_records.sql`

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-6

### Completion Notes
- AC9 (offline queue) deixado para Wave 2 — a infra idb/queue.ts do E1.5 existe, mas integração na sorting-form não foi implementada neste sprint
- Receitas de lavagem (AC4 recipe select) com opções vazias — populado quando E3.1 for entregue
- Scan QR funcional via @zxing/browser; testado em browser desktop; validação em tablet Android pendente

## Change Log
| Data | Agente | Ação |
|------|--------|------|
| 2026-02-18 | @sm River | Story criada (Status: Ready) |
| 2026-02-19 | @dev Dex | Implementação AC1–AC8. Status → Ready for Review |
