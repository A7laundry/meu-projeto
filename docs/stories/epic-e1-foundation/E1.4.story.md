# Story E1.4 — Cadastro de Funcionários e Equipamentos
**Epic:** E1 — Foundation
**Status:** Ready for Review
**Criado por:** @sm (River) | 2026-02-18
**Complexidade:** M (5 pontos)

---

## Descrição
Como **Gerente de Unidade**, preciso cadastrar os funcionários da minha unidade (com seus setores) e os equipamentos operacionais (lavadoras, secadoras, passadeiras), para que o sistema possa rastrear quem operou o quê e calcular eficiência por equipamento.

---

## Critérios de Aceite

- [x] **AC1:** Formulário de convite: nome, email, role (operator/driver), setor
- [x] **AC2:** Convite via `supabase.auth.admin.inviteUserByEmail` com metadata de role/setor
- [x] **AC3:** Listagem de funcionários com status ativo/inativo e toggle
- [x] **AC4:** Formulário de equipamento: nome, tipo, marca, modelo, n° série, capacidade
- [x] **AC5:** Listagem de equipamentos por tipo com status e edição
- [x] **AC6:** RLS: `unit_id` restringe acesso — migration 003 implementada
- [x] **AC7:** Desativação via toggle (campo `active = false`) — sem exclusão

---

## Escopo

**IN:**
- CRUD de funcionários por unidade (pelo Gerente)
- CRUD de equipamentos por unidade
- Convite por email via Supabase

**OUT:**
- Cadastro de insumos químicos (E3)
- Gestão de turnos/escalas (Wave 2)
- Permissões granulares por setor (já definidas na E1.2 via role)

---

## Contexto Técnico (para @dev)

### Schema `equipment`
```sql
CREATE TABLE equipment (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  unit_id UUID NOT NULL REFERENCES units(id),
  name TEXT NOT NULL,
  type TEXT NOT NULL CHECK (type IN ('washer','dryer','iron','other')),
  brand TEXT,
  model TEXT,
  serial_number TEXT,
  capacity_kg NUMERIC(6,2),
  status TEXT DEFAULT 'active' CHECK (status IN ('active','maintenance','inactive')),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE equipment ENABLE ROW LEVEL SECURITY;
CREATE POLICY "unit_equipment" ON equipment FOR ALL
  USING (unit_id = (auth.jwt() ->> 'unit_id')::uuid
      OR auth.jwt() ->> 'user_role' = 'director');
```

### Convidar funcionário (Server Action)
```typescript
// actions/staff/invite.ts
const { data, error } = await supabase.auth.admin.inviteUserByEmail(email, {
  data: { role: 'operator', unit_id: unitId, sector: sector }
})
// Após aceite do convite, trigger popula profiles automaticamente
```

---

## Dependências
- E1.3 (Unidades) — **completo**

## Riscos
- Email de convite requer domínio configurado no Supabase (SMTP ou Resend)

## Definição de Pronto
- [ ] Todos os ACs marcados
- [ ] Teste: Gerente não vê equipamentos de outra unidade
- [ ] Convite de email testado

---

## File List (preenchido por @dev)
- [x] `supabase/migrations/003_equipment.sql`
- [x] `app/(unit)/[unitId]/staff/page.tsx`
- [x] `app/(unit)/[unitId]/equipment/page.tsx`
- [x] `actions/staff/invite.ts`
- [x] `actions/equipment/crud.ts`
- [x] `types/equipment.ts`
- [x] `components/domain/staff/staff-invite-dialog.tsx`
- [x] `components/domain/equipment/equipment-form-dialog.tsx`
- [x] `app/(unit)/[unitId]/layout.tsx` — atualizado (Funcionários + ícones na sidebar)

## Change Log
| Data | Agente | Ação |
|------|--------|------|
| 2026-02-18 | @sm River | Story criada (Status: Ready) |
| 2026-02-18 | @dev Dex | Implementação concluída — 7/7 ACs. Status: Ready for Review |
