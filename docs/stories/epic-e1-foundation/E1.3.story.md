# Story E1.3 — Multi-Tenant: Cadastro de Unidades
**Epic:** E1 — Foundation
**Status:** Ready for Review
**Criado por:** @sm (River) | 2026-02-18
**Complexidade:** M (5 pontos)

---

## Descrição
Como **Diretor**, preciso cadastrar e gerenciar as 12 unidades da rede, com dados completos de cada unidade, para que o sistema isole corretamente os dados operacionais por unidade e permita visão consolidada e por unidade.

---

## Critérios de Aceite

- [x] **AC1:** Migration `002_units.sql` — tabela units com todos os campos
- [x] **AC2:** RLS: Diretor vê todas, demais usuários veem apenas sua unidade
- [x] **AC3:** Tela `/director/units` com listagem, status e ações
- [x] **AC4:** Formulário modal (Dialog) de criação/edição com validação Zod
- [x] **AC5:** Seed `units.sql` com 12 unidades — *dados reais a preencher pelo usuário*
- [x] **AC6:** FK profiles→units criada na migration 002
- [x] **AC7:** `useCurrentUnit()` hook client-side criado
- [x] **AC8:** Layout da unidade com header (nome da unidade) e sidebar de navegação

---

## Escopo

**IN:**
- CRUD de unidades (Diretor)
- RLS por unidade
- Seed com as 12 unidades
- Layout base da unidade

**OUT:**
- Cadastro de funcionários por unidade (E1.4)
- Cadastro de equipamentos por unidade (E1.4)
- Configurações avançadas da unidade (horários, metas) — Wave 2

---

## Contexto Técnico (para @dev)

### Schema `units`
```sql
CREATE TABLE units (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL,  -- ex: 'sao-paulo-centro'
  address TEXT,
  city TEXT NOT NULL,
  state CHAR(2) NOT NULL,
  phone TEXT,
  active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE units ENABLE ROW LEVEL SECURITY;

-- Diretor: vê todas
CREATE POLICY "director_all" ON units FOR ALL
  USING (auth.jwt() ->> 'user_role' = 'director');

-- Outros: vê apenas a sua unidade
CREATE POLICY "unit_own" ON units FOR SELECT
  USING (id = (auth.jwt() ->> 'unit_id')::uuid);
```

### Hook `useCurrentUnit`
```typescript
// hooks/use-current-unit.ts
export function useCurrentUnit() {
  // Lê unit_id do JWT via supabase.auth.getUser()
  // Retorna dados da unidade do banco
}
```

### Padrão de URL por unidade
```
/unit/[unitId]/dashboard
/unit/[unitId]/production
/unit/[unitId]/equipment
```
O `unitId` é o UUID da unidade. Para Diretor, pode navegar entre unidades.

---

## Dependências
- E1.2 (Autenticação) — **completo**

## Riscos
- Seed das 12 unidades reais precisa de dados fornecidos pelo cliente

## Definição de Pronto
- [ ] Todos os ACs marcados
- [ ] RLS testado (Gerente não vê outras unidades)
- [ ] Seed executado com as 12 unidades

---

## File List (preenchido por @dev)
- [x] `supabase/migrations/002_units.sql`
- [x] `supabase/seed/units.sql`
- [x] `app/(director)/units/page.tsx`
- [x] `app/(director)/layout.tsx` — layout do Diretor com sidebar
- [x] `app/(unit)/[unitId]/layout.tsx`
- [x] `hooks/use-current-unit.ts`
- [x] `types/unit.ts` — já existia
- [x] `actions/units/crud.ts`
- [x] `components/domain/unit/unit-form-dialog.tsx`
- [x] `components/domain/unit/unit-toggle-button.tsx`

## Change Log
| Data | Agente | Ação |
|------|--------|------|
| 2026-02-18 | @sm River | Story criada (Status: Ready) |
| 2026-02-18 | @dev Dex | Implementação concluída — 8/8 ACs. Status: Ready for Review |
