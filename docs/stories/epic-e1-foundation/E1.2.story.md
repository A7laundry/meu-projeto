# Story E1.2 — Sistema de Autenticação com Perfis
**Epic:** E1 — Foundation
**Status:** Ready for Review
**Criado por:** @sm (River) | 2026-02-18
**Complexidade:** L (8 pontos)

---

## Descrição
Como **usuário do sistema** (Diretor, Gerente, Funcionário, Loja ou Cliente), preciso fazer login com email/senha e ter meu acesso restrito ao meu perfil e unidade, para que cada pessoa veja apenas o que é relevante ao seu papel.

---

## Critérios de Aceite

- [x] **AC1:** Página de login (`/login`) com formulário email + senha, feedback de erro via redirect
- [x] **AC2:** Login via Supabase Auth com Server Action (`actions.ts`)
- [x] **AC3:** Redirecionamento automático por role após login
- [x] **AC4:** Middleware protegendo todas as rotas autenticadas
- [ ] **AC5:** JWT customizado — *requer configuração manual no Supabase Dashboard (instrução na migration)*
- [x] **AC6:** Logout via Server Action limpando sessão + cookies
- [x] **AC7:** Sessão persistida (Supabase SSR + cookies)
- [x] **AC8:** Migration `001_profiles.sql` criada com tabela + RLS + trigger
- [x] **AC9:** Página `/auth/error` para acesso negado

---

## Escopo

**IN:**
- Fluxo completo de login e logout
- Middleware de proteção de rotas
- Redirecionamento por role
- JWT customizado com claims de negócio
- Tabela `profiles` no banco

**OUT:**
- Cadastro de novos usuários (feito pelo Gerente/Admin — história futura)
- Recuperação de senha (Wave 2)
- Login social (Google, etc.) — não previsto
- 2FA — não previsto no MVP

---

## Contexto Técnico (para @dev)

### Tabela `profiles` (Supabase)
```sql
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  full_name TEXT NOT NULL,
  role TEXT NOT NULL CHECK (role IN ('director','unit_manager','operator','driver','store','customer')),
  unit_id UUID REFERENCES units(id),
  sector TEXT CHECK (sector IN ('sorting','washing','drying','ironing','shipping')),
  active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
-- RLS: usuário lê apenas seu próprio perfil
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
CREATE POLICY "self_read" ON profiles FOR SELECT USING (auth.uid() = id);
```

### Supabase Auth Hook (JWT customizado)
```sql
-- Adicionar claims customizados ao JWT
CREATE OR REPLACE FUNCTION custom_access_token_hook(event jsonb)
RETURNS jsonb LANGUAGE plpgsql AS $$
DECLARE
  claims jsonb;
  user_role text;
  user_unit_id uuid;
  user_sector text;
BEGIN
  SELECT role, unit_id, sector INTO user_role, user_unit_id, user_sector
  FROM profiles WHERE id = (event->>'user_id')::uuid;

  claims := event->'claims';
  claims := jsonb_set(claims, '{user_role}', to_jsonb(user_role));
  claims := jsonb_set(claims, '{unit_id}', to_jsonb(user_unit_id));
  claims := jsonb_set(claims, '{sector}', to_jsonb(user_sector));
  RETURN jsonb_set(event, '{claims}', claims);
END;
$$;
```

### Middleware (`middleware.ts`)
```typescript
// Proteger rotas por role
const ROLE_ROUTES = {
  '/director': ['director'],
  '/unit': ['director', 'unit_manager'],
  '/sector': ['operator'],
  '/driver': ['driver'],
  '/client': ['store', 'customer'],
}
```

### Tipos TypeScript (`types/auth.ts`)
```typescript
export type UserRole = 'director' | 'unit_manager' | 'operator' | 'driver' | 'store' | 'customer'
export type Sector = 'sorting' | 'washing' | 'drying' | 'ironing' | 'shipping'

export interface UserProfile {
  id: string
  full_name: string
  role: UserRole
  unit_id: string | null
  sector: Sector | null
  active: boolean
}
```

---

## Dependências
- E1.1 (Setup do projeto) — **completo**

## Riscos
- JWT Hook do Supabase requer configuração no dashboard (não automático via código)

## Definição de Pronto
- [ ] Todos os ACs marcados
- [ ] Login testado com 1 usuário de cada role
- [ ] Middleware bloqueando rotas não autorizadas
- [ ] `npm run build` + `lint` + `typecheck` passando

---

## File List (preenchido por @dev)
- [x] `app/(auth)/login/page.tsx` — formulário de login com Server Action
- [x] `app/(auth)/login/actions.ts` — login + logout Server Actions
- [x] `app/(auth)/error/page.tsx` — página de acesso negado
- [x] `app/(director)/dashboard/page.tsx` — placeholder Diretor
- [x] `app/(unit)/[unitId]/dashboard/page.tsx` — placeholder Gerente
- [x] `app/(sector)/[sector]/page.tsx` — placeholder Operador
- [x] `app/(driver)/route/page.tsx` — placeholder Motorista
- [x] `app/(client)/orders/page.tsx` — placeholder Cliente
- [x] `middleware.ts` — proteção de rotas por role
- [x] `types/auth.ts` — já existia, utilizado
- [x] `lib/auth/get-user.ts` — helper getUser + requireUser
- [x] `supabase/migrations/001_profiles.sql` — tabela, RLS, trigger, instrução do Auth Hook

## Notas do Dev
- **AC5 (JWT Hook):** Requer configuração manual no Supabase Dashboard → Authentication → Hooks. SQL comentado na migration 001.
- **Validação Zod no formulário:** Implementada via redirect com error params (Server Component). Para validação client-side em tempo real, usar `useActionState` na E1.6 (layout com componentes interativos).

## Change Log
| Data | Agente | Ação |
|------|--------|------|
| 2026-02-18 | @sm River | Story criada (Status: Ready) |
| 2026-02-18 | @dev Dex | Implementação concluída — 8/9 ACs (AC5 manual). Status: Ready for Review |
